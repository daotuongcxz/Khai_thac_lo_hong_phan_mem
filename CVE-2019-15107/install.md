# Hướng dẫn cài đặt môi trường thực nghiệm CVE-2019-15107:
Webmin là công vụ quản trị hệ thống Unix dựa trên giao diện web. Quản trị viên truy cập các chưc năng  quản lý khác nhau của Webmin thông qua trình duyệt và hoàn thành các hành động quản lý tương ứng.
Vào ngày 10 tháng 8 năm 2019, lỗ hổng Thực thi mã từ xa trái phép Webmin **CVE-2019-15107** đã được phát hành trên Pentest. Khi chức năng đặt lại mật khẩu Webmin được bật, kẻ tấn công có thể thực thi các lệnh tùy ý trên hệ thống đích bằng cách gửi yêu cầu POST cụ thể đến trang chức năng và RCE không được cấp phép nếu không có xác thực. **password_change.cgi**
Version ảnh hưởng: 1.890 <= Webmin <= 1.920


# Triển khai môi trường
## 1. Triển khai webmin dưới dạng service
**version**
```
webmin：1.920
OS: Ubuntu 18.04.6 LTS
```
**Installation**
Để cài đặt một phiên bản cụ thể của webmin, chúng ta có thể sử dụng 2 phương pháp: thông qua công cụ quản lý gói (dpkg,apt) hoặc cài đặt thủ công. Trong hướng dẫn này, chũng ta sử dụng cách thứ 2: 
Thực hiện download gói nén webmin 1.920 từ trang web chính thức: 
```
https://sourceforge.net/projects/webadmin/files/webmin/
# download trên terminal
wget http://prdownloads.sourceforge.net/webadmin/webmin-1.920.tar.gz
```
Giải nén gói phần mềm:
```
tar -xvf webmin-1.920.tar.gz
```
Tạo các thư mục phục vụ cấu hình cho webmin:
```
mkdir -p /usr/local/share/webmin/webmin-1.920 
mkdir -p /etc/webmin/webmin-1.920 
mkdir -p /var/webmin/webmin-1.920
mkdir -p /usr/local/share/webmin/webmin-1.920 /etc/webmin/webmin-1.920 /var/webmin/webmin-1.920  
```
Thực hiện cài đặt: truy cập thư mục đã giải nén và và chạy file cài đặt:
```
# cd webmin-1.920/
# ./setup.sh /usr/local/share/webmin/webmin-1.920/
***********************************************************************
*            Welcome to the Webmin setup script, version 1.920        *
***********************************************************************
Webmin is a web-based interface that allows Unix-like operating
systems and common Unix services to be easily administered.

Installing Webmin from /root/webmin-1.920 to /usr/local/share/webmin/webmin-1.920/ ...

***********************************************************************
Webmin uses separate directories for configuration files and log files.
Unless you want to run multiple versions of Webmin at the same time
you can just accept the defaults.

Config file directory [/etc/webmin]: /etc/webmin/webmin-1.920
Log file directory [/var/webmin]: /var/webmin/webmin-1.920

***********************************************************************
Webmin is written entirely in Perl. Please enter the full path to the
Perl 5 interpreter on your system.

Full path to perl (default /usr/bin/perl):

Testing Perl ...
Perl seems to be installed ok

***********************************************************************
Operating system name:    Ubuntu Linux
Operating system version: 18.04.6

***********************************************************************
Webmin uses its own password protected web server to provide access
to the administration programs. The setup script needs to know :
 - What port to run the web server on. There must not be another
   web server already using this port.
 - The login name required to access the web server.
 - The password required to access the web server.
 - If the webserver should use SSL (if your system supports it).
 - Whether to start webmin at boot time.

Web server port (default 10000): 10000
Login name (default admin): admin
Login password:
Password again:
The Perl SSLeay library is not installed. SSL not available.
Webmin does not support being started at boot time on your system.
***********************************************************************
Copying files to /usr/local/share/webmin/webmin-1.920/ ..
..done

Creating web server config files..
..done

Creating access control file..
..done

Inserting path to perl into scripts..
..done

Creating start and stop scripts..
..done

Copying config files..
..done

Creating uninstall script /etc/webmin/webmin-1.920/uninstall.sh ..
..done

Changing ownership and permissions ..
..done

Running postinstall scripts ..
..done

Enabling background status collection ..
..done

Attempting to start Webmin mini web server..
Starting Webmin server in /usr/local/share/webmin/webmin-1.920/
..done

***********************************************************************
Webmin has been installed and started successfully. Use your web
browser to go to

  http://elk:10000/

and login with the name and password you entered previously.
```
Thực hiện truy cập webmin sau quá trình cài đặt:
```
http://ip_host_webmin:10000
```
![Trang login](/CVE-2019-15107/image/tranglogin.png)

Cách khởi động dịch vụ webmin thủ công: 
```
# /usr/bin/perl /usr/local/share/webmin/webmin-1.920/miniserv.pl /etc/webmin/webmin-1.920/miniserv.conf
```
**Password Reset**
Có 3 cách để quản lý chính sách mật khẩu đã hết hạn trong webmin:
* Always deny users with expired passwords [mặc định]
* Always allow users with expired passwords
* Prompt users with expired passwords to enter a new one

Đăng nhập vào webmin và click chọn: **Webmin-> Webmin Configuration-> Authentication**
![pass_reset](/CVE-2019-15107/image/passreset.png)
Xem tập cấu hình sau khi được save và khởi động lại, trong đó chính sách hết hạn mật khẩu đã có hiệu lực và giá trị 0,1,2 tương ứng cho 3 chính sách trên. `miniserv.conf``passwd_mode=2``0、1、2`
```
# cat /etc/webmin/webmin-1.920/miniserv.conf | grep passwd_mode
passwd_mode=2
```

## 2. Triển khai webmin dựa trên công nghệ docker container

**Install docker**
```
# apt install docker docker-compose
```
kiểm tra lại sau khi cài đặt:
```
# docker --version
Docker version 20.10.21, build 20.10.21-0ubuntu1~18.04.3
# docker-compose --version
docker-compose version 1.17.1
```
**Download repo và chạy container webmin**
```
#git clone https://github.com/vulhub/vulhub
#cd vulhub/webmin/CVE-2019-15107/ 
#docker-compose up -d 
# docker-compose ps # xem cổng được ánh xạ
       Name                 Command          State                      Ports
-------------------------------------------------------------------------------------------------
cve201915107_web_1   /docker-entrypoint.sh   Up      0.0.0.0:10000->10000/tcp,:::10000->10000/tcp
```
**Đặt lại password cho user root**
```
# docker ps
CONTAINER ID   IMAGE                 COMMAND                  CREATED         STATUS         PORTS                                           NAMES
e928734523f2   vulhub/webmin:1.910   "/docker-entrypoint.…"   3 minutes ago   Up 2 minutes   0.0.0.0:10000->10000/tcp, :::10000->10000/tcp   cve201915107_web_1
root@elk:~/vulhub/webmin/CVE-2019-15107# docker exec -it e928734523f2 /bin/bash
root@e928734523f2:/#
root@e928734523f2:/# /usr/share/webmin/changepass.pl /etc/webmin root new_password
Updated password of Webmin user root
```
Thực hiện truy cập webmin sau quá trình cài đặt:
```
https://ip_host:10000
```
![tranglogin](/CVE-2019-15107/image/login2.png)

Đăng nhập vào webmin và click chọn: **Webmin-> Webmin Configuration-> Authentication**  
![pass_reset](/CVE-2019-15107/image/passreset.png)
Xem tập cấu hình sau khi được save và khởi động lại:
```
# cat /etc/webmin/webmin-1.920/miniserv.conf | grep passwd_mode
passwd_mode=2
```
